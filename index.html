<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PentathlonScore – Live Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }

    header {
      background: #111827;
      color: #f9fafb;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .logo {
      font-weight: 600;
      font-size: 1.1rem;
      text-decoration: none;
      color: #f9fafb;
    }

    nav {
      display: flex;
      gap: 12px;
      margin-top: 6px;
    }

    .nav-link {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .nav-link:hover {
      background: #1f2937;
    }

    .nav-link.active {
      background: #4f46e5;
      color: #f9fafb;
    }

    main {
      max-width: 1100px;
      margin: 16px auto 40px;
      padding: 0 12px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 14px 14px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 4px;
    }

    h2 {
      font-size: 1.1rem;
      margin: 0 0 4px;
    }

    h3 {
      font-size: 1rem;
      margin: 0 0 4px;
    }

    p {
      margin: 4px 0;
      font-size: 0.9rem;
      color: #4b5563;
    }

    .note {
      font-size: 0.85rem;
      color: #6b7280;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #374151;
    }

    select {
      width: 100%;
      max-width: 320px;
      padding: 6px 8px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #d1d5db;
    }

    select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
    }

    .message {
      font-size: 0.85rem;
      margin-top: 6px;
    }

    .message.error {
      color: #b91c1c;
    }

    .message.info {
      color: #6b7280;
    }

    .comp-meta {
      font-size: 0.85rem;
      color: #4b5563;
      margin-top: 6px;
    }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      font-size: 0.75rem;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      margin-right: 4px;
    }

    .pill.status-live {
      background: #dcfce7;
      color: #166534;
    }

    .pill.status-finished {
      background: #fee2e2;
      color: #991b1b;
    }

    .division-jump-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .division-jump-btn {
      border: 1px solid #d1d5db;
      background: #f9fafb;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      color: #111827;
    }

    .division-jump-btn:hover {
      background: #e5e7eb;
    }

    .print-btn {
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: none;
      background: #4f46e5;
      color: white;
      cursor: pointer;
    }

    .print-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .print-btn:not(:disabled):hover {
      background: #4338ca;
    }

    .division-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .division-tags {
      font-size: 0.8rem;
      color: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 6px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
      text-align: right;
    }

    th:first-child,
    td:first-child {
      text-align: center;
    }

    th:nth-child(2),
    td:nth-child(2) {
      text-align: left;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .rank-cell {
      text-align: center;
      font-weight: 600;
      width: 60px;
    }

    .name-cell {
      font-weight: 500;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .noc-cell {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .disc-cell {
      font-size: 0.8rem;
      font-variant-numeric: tabular-nums;
    }

    .handicap-cell {
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 640px) {
      th, td {
        padding: 4px 6px;
        font-size: 0.8rem;
      }
      .division-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .name-cell {
        max-width: 150px;
      }
    }

    /* Print styles */
    @media print {
      header {
        display: none;
      }
      body {
        background: #ffffff;
      }
      main {
        max-width: none;
        margin: 0;
        padding: 0;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        margin: 0 0 8px;
      }
      #competition-select,
      #competition-message,
      #division-jump-container,
      .print-btn,
      .note {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <a href="/" class="logo">PentathlonScore</a>
    <nav>
      <a href="/" class="nav-link active">Home</a>
      <a href="/admin-login.html" class="nav-link">Admin</a>
    </nav>
  </header>

  <main>
    <div class="card">
      <h1>Live Results</h1>
      <p class="note">
        Select a competition to view division leaderboards. Results are updated live by the admin.
      </p>

      <label for="competition-select">Competition</label>
      <select id="competition-select">
        <option value="">Select a competition</option>
      </select>
      <div id="competition-message" class="message info"></div>
      <div id="competition-meta" class="comp-meta"></div>

      <!-- Division quick-jump buttons -->
      <div id="division-jump-container" class="division-jump-container"></div>

      <!-- Print button -->
      <button
        type="button"
        id="print-btn"
        class="print-btn"
        disabled
        style="display:none;"
      >
        Print Results
      </button>
    </div>

    <div id="leaderboard-container"></div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://cbwifmgrekugoljcaqoh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNid2lmbWdyZWt1Z29samNhcW9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDcxODYsImV4cCI6MjA4MDI4MzE4Nn0.Rp5MCWYQL9SxbnBEJ7e76gbbd95qsStaLE2Hkhpn47g";

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const competitionSelect = document.getElementById("competition-select");
    const competitionMessage = document.getElementById("competition-message");
    const competitionMeta = document.getElementById("competition-meta");
    const divisionJumpContainer = document.getElementById("division-jump-container");
    const leaderboardContainer = document.getElementById("leaderboard-container");
    const printBtn = document.getElementById("print-btn");

    let competitionsCache = [];

    function setCompetitionMessage(text, type = "info") {
      competitionMessage.textContent = text || "";
      competitionMessage.className = "message " + type;
    }

    function formatStatusPill(status) {
      const s = (status || "").toLowerCase();
      let cls = "pill";
      if (s === "live") cls += " status-live";
      else if (s === "finished") cls += " status-finished";
      return `<span class="${cls}">${s || ""}</span>`;
    }

    function formatDateRange(start, end) {
      if (!start && !end) return "";
      if (start && !end) return start;
      if (!start && end) return end;
      if (start === end) return start;
      return `${start} – ${end}`;
    }

    function formatHandicap(seconds) {
      if (seconds == null || isNaN(seconds)) return "";
      const total = Math.round(Number(seconds)); // assume stored as seconds
      const sign = total < 0 ? "-" : "";
      const abs = Math.abs(total);
      const m = Math.floor(abs / 60);
      const s = abs % 60;
      const sStr = s < 10 ? "0" + s : "" + s;
      return sign + m + ":" + sStr;
    }

    function formatDisciplineCell(discObj) {
      if (!discObj) return "";
      const raw = (discObj.raw || "").trim();
      const pts = (typeof discObj.pts === "number") ? discObj.pts : null;

      if (raw && pts != null) return `${raw} (${pts})`;
      if (raw) return raw;
      if (pts != null) return String(pts);
      return "";
    }

    function buildDivisionRows(division) {
      const entries = division.entries || [];
      const rows = entries.map(e => {
        const a = e.athletes || e.athlete || {};
        const resArr = e.results || [];

        const byDisc = {
          fence: { raw: null, pts: null },
          swim: { raw: null, pts: null },
          obstacle: { raw: null, pts: null },
          laser: { raw: null, pts: null }
        };

        resArr.forEach(r => {
          if (!r || !r.discipline) return;
          const key = r.discipline;
          if (!byDisc[key]) return;
          byDisc[key] = {
            raw: r.raw_value || null,
            pts: typeof r.points === "number" ? r.points : (r.points == null ? null : Number(r.points))
          };
        });

        const total = ["fence", "swim", "obstacle", "laser"].reduce((sum, d) => {
          const val = byDisc[d].pts;
          return sum + (typeof val === "number" ? val : 0);
        }, 0);

        const first = a.first_name || "";
        const last = a.last_name || "";
        const name = (first + " " + last).trim();

        return {
          entryId: e.id,
          name,
          noc: a.noc || "",
          fence: byDisc.fence,
          swim: byDisc.swim,
          obstacle: byDisc.obstacle,
          laser: byDisc.laser,
          total,
          handicap: e.handicap
        };
      });

      // Sort by Total desc, then name asc
      rows.sort((a, b) => {
        if (b.total !== a.total) return b.total - a.total;
        return a.name.localeCompare(b.name);
      });

      return rows;
    }

    function renderDivisionJumpButtons(competition) {
      const divisions = (competition.divisions || [])
        .slice()
        .sort((a, b) => {
          const ao = a.order_index ?? 0;
          const bo = b.order_index ?? 0;
          if (ao !== bo) return ao - bo;
          return (a.name || "").localeCompare(b.name || "");
        });

      if (!divisions.length) {
        divisionJumpContainer.innerHTML = "";
        return;
      }

      const buttonsHtml = divisions.map(d => {
        const label = d.name || "Division";
        return `
          <button
            type="button"
            class="division-jump-btn"
            onclick="scrollToDivision('division-${d.id}')"
          >
            ${label}
          </button>
        `;
      }).join("");

      divisionJumpContainer.innerHTML = buttonsHtml;
    }

    function renderCompetitionLeaderboards(competition) {
      if (!competition) {
        leaderboardContainer.innerHTML = "";
        divisionJumpContainer.innerHTML = "";
        competitionMeta.innerHTML = "";
        printBtn.disabled = true;
        printBtn.style.display = "none";
        return;
      }

      const statusHtml = formatStatusPill(competition.status);
      const range = formatDateRange(competition.start_date, competition.end_date);
      const location = competition.location || "";

      competitionMeta.innerHTML = `
        ${statusHtml}
        ${location ? `<span class="pill">${location}</span>` : ""}
        ${range ? `<span class="pill">${range}</span>` : ""}
      `;

      renderDivisionJumpButtons(competition);

      const divisions = (competition.divisions || [])
        .slice()
        .sort((a, b) => {
          const ao = a.order_index ?? 0;
          const bo = b.order_index ?? 0;
          if (ao !== bo) return ao - bo;
          return (a.name || "").localeCompare(b.name || "");
        });

      if (!divisions.length) {
        leaderboardContainer.innerHTML = `
          <div class="card">
            <p class="note">No divisions have been added for this competition yet.</p>
          </div>
        `;
        printBtn.disabled = true;
        printBtn.style.display = "none";
        return;
      }

      const html = divisions.map(div => {
        const rows = buildDivisionRows(div);
        const tags = [];
        if (div.age_group) tags.push(div.age_group);
        if (div.gender) tags.push(div.gender);

        if (!rows.length) {
          return `
            <div class="card" id="division-${div.id}">
              <div class="division-header">
                <h2>${div.name || "Division"}</h2>
                <div class="division-tags">
                  ${tags.map(t => `<span class="pill">${t}</span>`).join(" ")}
                </div>
              </div>
              <p class="note">No athletes or results yet for this division.</p>
            </div>
          `;
        }

        const body = rows.map((r, idx) => `
          <tr>
            <td class="rank-cell">${idx + 1}</td>
            <td>
              <div class="name-cell">${r.name || ""}</div>
              <div class="noc-cell">${r.noc || ""}</div>
            </td>
            <td class="disc-cell">${formatDisciplineCell(r.fence)}</td>
            <td class="disc-cell">${formatDisciplineCell(r.swim)}</td>
            <td class="disc-cell">${formatDisciplineCell(r.obstacle)}</td>
            <td class="disc-cell">${formatDisciplineCell(r.laser)}</td>
            <td>${r.total || 0}</td>
            <td class="handicap-cell">${formatHandicap(r.handicap)}</td>
          </tr>
        `).join("");

        return `
          <div class="card" id="division-${div.id}">
            <div class="division-header">
              <h2>${div.name || "Division"}</h2>
              <div class="division-tags">
                ${tags.map(t => `<span class="pill">${t}</span>`).join(" ")}
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Place</th>
                  <th>Athlete</th>
                  <th>Fence</th>
                  <th>Swim</th>
                  <th>Obstacle</th>
                  <th>Laser Run</th>
                  <th>Total</th>
                  <th>Handicap<br/><span style="font-size:0.7rem;">m:ss</span></th>
                </tr>
              </thead>
              <tbody>
                ${body}
              </tbody>
            </table>
          </div>
        `;
      }).join("");

      leaderboardContainer.innerHTML = html;

      // Enable and show print button
      printBtn.disabled = false;
      printBtn.style.display = "inline-block";
    }

    async function loadCompetitions() {
      setCompetitionMessage("Loading competitions...", "info");

      const { data, error } = await supabase
        .from("competitions")
        .select(`
          id,
          name,
          location,
          start_date,
          end_date,
          status,
          divisions (
            id,
            name,
            age_group,
            gender,
            order_index,
            entries (
              id,
              handicap,
              athletes (
                first_name,
                last_name,
                noc
              ),
              results (
                discipline,
                raw_value,
                points
              )
            )
          )
        `)
        .in("status", ["live", "finished"])
        .order("start_date", { ascending: false });

      if (error) {
        console.error(error);
        setCompetitionMessage("Failed to load competitions.", "error");
        competitionSelect.innerHTML = '<option value="">Select a competition</option>';
        leaderboardContainer.innerHTML = "";
        return;
      }

      competitionsCache = data || [];

      if (!competitionsCache.length) {
        setCompetitionMessage("No live or finished competitions are currently available.", "info");
        competitionSelect.innerHTML = '<option value="">Select a competition</option>';
        leaderboardContainer.innerHTML = "";
        printBtn.disabled = true;
        printBtn.style.display = "none";
        return;
      }

      setCompetitionMessage("");

      const options = competitionsCache.map(c => `
        <option value="${c.id}">${c.name}</option>
      `).join("");

      competitionSelect.innerHTML = `
        <option value="">Select a competition</option>
        ${options}
      `;
    }

    competitionSelect.addEventListener("change", () => {
      const id = competitionSelect.value;
      if (!id) {
        competitionMeta.innerHTML = "";
        divisionJumpContainer.innerHTML = "";
        leaderboardContainer.innerHTML = "";
        printBtn.disabled = true;
        printBtn.style.display = "none";
        return;
      }

      const comp = competitionsCache.find(c => String(c.id) === String(id));
      if (!comp) return;

      renderCompetitionLeaderboards(comp);
    });

    // Print handler
    printBtn.addEventListener("click", () => {
      window.print();
    });

    // global for inline onclick
    function scrollToDivision(targetId) {
      const el = document.getElementById(targetId);
      if (!el) return;
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    window.scrollToDivision = scrollToDivision;

    (async function init() {
      await loadCompetitions();
    })();
  </script>
</body>
</html>
