<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PentathlonScore – Live Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f7;
      color: #222;
    }

    header {
      background: #111827;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 1.25rem;
      margin: 0;
    }

    .nav-links {
      display: flex;
      gap: 12px;
      font-size: 0.9rem;
      flex-wrap: wrap;
    }

    .nav-links a {
      color: #cbd2ff;
      text-decoration: none;
    }

    .nav-links a:hover {
      text-decoration: underline;
    }

    main {
      max-width: 1100px;
      margin: 16px auto;
      padding: 0 12px 32px;
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
    }

    select, button {
      font-size: 0.95rem;
      padding: 6px 10px;
    }

    button {
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #e5e7eb;
      cursor: pointer;
    }

    button:hover {
      background: #d4d7dd;
    }

    .results-header {
      margin-bottom: 8px;
      font-size: 0.95rem;
      color: #333;
    }

    .results-header span {
      color: #4b5563;
      font-size: 0.9rem;
    }

    .category-block {
      margin-top: 18px;
      margin-bottom: 10px;
    }

    .category-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.98rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    thead {
      background: #1f2937;
      color: #fff;
    }

    th, td {
      padding: 6px 8px;
      font-size: 0.85rem;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }

    th:nth-child(2), td:nth-child(2) {
      text-align: left;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .no-results {
      font-size: 0.95rem;
      color: #555;
      margin-top: 12px;
    }

    @media (max-width: 800px) {
      th, td {
        font-size: 0.75rem;
        padding: 4px 6px;
      }
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .nav-links {
        margin-top: 6px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>PentathlonScore – Live Results</h1>
    <nav class="nav-links">
      <a href="/">Home</a>
      <a href="/admin-login.html">Admin</a>
    </nav>
  </header>

  <main>
    <h2>Select Competition</h2>
    <div class="controls">
      <select id="competitionSelect">
        <option value="">Select a competition</option>
      </select>
      <button id="clearBtn">Clear</button>
    </div>

    <div id="resultsContainer">
      <p class="no-results">Select a competition to view live results.</p>
    </div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://cbwifmgrekugoljcaqoh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNid2lmbWdyZWt1Z29samNhcW9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDcxODYsImV4cCI6MjA4MDI4MzE4Nn0.Rp5MCWYQL9SxbnBEJ7e76gbbd95qsStaLE2Hkhpn47g";

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const selectEl = document.getElementById("competitionSelect");
    const clearBtn = document.getElementById("clearBtn");
    const resultsContainer = document.getElementById("resultsContainer");

    function formatDate(d) {
      if (!d) return "";
      return d;
    }

    function disciplineObj(resultsArr, disc) {
      if (!resultsArr) return { raw: null, points: null };
      const r = resultsArr.find(x => x.discipline === disc);
      if (!r) return { raw: null, points: null };
      return {
        raw: r.raw_value || null,
        points: r.points !== null && r.points !== undefined ? Number(r.points) : null
      };
    }

    function formatDisciplineCell(obj) {
      if (!obj) return "-";
      const hasRaw = obj.raw && obj.raw !== "";
      const hasPts = obj.points !== null && !Number.isNaN(obj.points);
      if (hasRaw && hasPts) return `${obj.raw} (${obj.points})`;
      if (hasRaw) return obj.raw;
      if (hasPts) return String(obj.points);
      return "-";
    }

    function buildCategoryTable(category) {
      const entries = category.entries || [];
      if (entries.length === 0) {
        return `
          <div class="category-block">
            <div class="category-title">${category.label}</div>
            <div class="no-results">No athletes entered yet for this division.</div>
          </div>
        `;
      }

      const rowsData = entries.map((e) => {
        const a = e.athletes || e.athlete || {};
        const fullName = [a.first_name, a.last_name].filter(Boolean).join(" ");
        const resArr = e.results || [];

        const fence = disciplineObj(resArr, "fence");
        const swim = disciplineObj(resArr, "swim");
        const obstacle = disciplineObj(resArr, "obstacle");
        const laser = disciplineObj(resArr, "laser");

        const pointsList = [fence, swim, obstacle, laser]
          .map(r => (r && r.points !== null && !Number.isNaN(r.points)) ? r.points : null);

        const totalPoints = pointsList.reduce((sum, p) => (p !== null ? sum + p : sum), 0);
        const hasAnyPoints = pointsList.some(p => p !== null);

        const handicapVal =
          e.handicap !== null && e.handicap !== undefined && !Number.isNaN(Number(e.handicap))
            ? Number(e.handicap)
            : null;

        return {
          entryId: e.id,
          name: fullName,
          noc: a.noc || "",
          fence,
          swim,
          obstacle,
          laser,
          totalPoints: hasAnyPoints ? totalPoints : null,
          handicap: handicapVal
        };
      });

      rowsData.sort((a, b) => {
        const aHas = a.totalPoints !== null;
        const bHas = b.totalPoints !== null;
        if (aHas && bHas) {
          return b.totalPoints - a.totalPoints; // higher points first
        }
        if (aHas && !bHas) return -1;
        if (!aHas && bHas) return 1;
        return a.name.localeCompare(b.name);
      });

      const rowsHtml = rowsData.map((r, idx) => {
        const rank = r.totalPoints !== null ? (idx + 1) : "-";
        const totalCell = r.totalPoints !== null ? r.totalPoints : "-";
        const handicapCell = r.handicap !== null ? r.handicap : "-";

        return `
          <tr>
            <td>${rank}</td>
            <td>${r.name}</td>
            <td>${r.noc}</td>
            <td>${formatDisciplineCell(r.fence)}</td>
            <td>${formatDisciplineCell(r.swim)}</td>
            <td>${formatDisciplineCell(r.obstacle)}</td>
            <td>${formatDisciplineCell(r.laser)}</td>
            <td>${totalCell}</td>
            <td>${handicapCell}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="category-block">
          <div class="category-title">${category.label}</div>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>NOC</th>
                <th>Fence</th>
                <th>Swim</th>
                <th>Obstacle</th>
                <th>Laser Run</th>
                <th>Total</th>
                <th>Handicap</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderResults(comp, categories) {
      if (!comp) {
        resultsContainer.innerHTML = '<p class="no-results">Select a competition to view live results.</p>';
      } else if (!categories || categories.length === 0) {
        resultsContainer.innerHTML = `
          <div class="results-header">
            <strong>${comp.name}</strong>
            <span>${comp.location ? " – " + comp.location : ""} ${comp.start_date ? " (" + formatDate(comp.start_date) + ")" : ""}</span>
          </div>
          <p class="no-results">No divisions configured yet for this competition.</p>
        `;
      } else {
        const sortedCategories = [...categories].sort((a, b) => {
          const agA = (a.age_group || "").toLowerCase();
          const agB = (b.age_group || "").toLowerCase();
          if (agA !== agB) return agA.localeCompare(agB);
          const gA = (a.gender || "").toLowerCase();
          const gB = (b.gender || "").toLowerCase();
          if (gA !== gB) return gA.localeCompare(gB);
          return a.label.localeCompare(b.label);
        });

        const categoriesHtml = sortedCategories.map(buildCategoryTable).join("");

        resultsContainer.innerHTML = `
          <div class="results-header">
            <strong>${comp.name}</strong>
            <span>${comp.location ? " – " + comp.location : ""} ${comp.start_date ? " (" + formatDate(comp.start_date) + ")" : ""}</span>
          </div>
          ${categoriesHtml}
        `;
      }
    }

    async function loadCompetitions() {
      const { data, error } = await supabase
        .from("competitions")
        .select("*")
        .in("status", ["live", "finished"])
        .order("start_date", { ascending: false });

      if (error) {
        console.error("Error loading competitions", error);
        resultsContainer.innerHTML = '<p class="no-results">Failed to load competitions.</p>';
        return;
      }

      selectEl.innerHTML = '<option value="">Select a competition</option>';
      (data || []).forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        selectEl.appendChild(opt);
      });

      if (!data || data.length === 0) {
        resultsContainer.innerHTML = '<p class="no-results">No live or finished competitions available.</p>';
      }
    }

    async function loadCompetitionWithDivisionsAndEntries(compId) {
      if (!compId) {
        renderResults(null, []);
        return;
      }

      const { data: comps, error: compError } = await supabase
        .from("competitions")
        .select("*")
        .eq("id", compId)
        .limit(1);

      if (compError || !comps || comps.length === 0) {
        console.error("Error loading competition", compError);
        resultsContainer.innerHTML = '<p class="no-results">Failed to load competition.</p>';
        return;
      }

      const competition = comps[0];

      const { data: divisions, error: divError } = await supabase
        .from("divisions")
        .select(`
          id,
          name,
          age_group,
          gender,
          entries (
            id,
            created_at,
            handicap,
            athletes (
              first_name,
              last_name,
              noc
            ),
            results (
              discipline,
              raw_value,
              points
            )
          )
        `)
        .eq("competition_id", compId)
        .order("order_index", { ascending: true })
        .order("name", { ascending: true });

      if (divError) {
        console.error("Error loading divisions", divError);
        resultsContainer.innerHTML = '<p class="no-results">Failed to load divisions.</p>';
        return;
      }

      const categories = (divisions || []).map(d => ({
        id: d.id,
        label: d.name,
        age_group: d.age_group,
        gender: d.gender,
        entries: d.entries || []
      }));

      renderResults(competition, categories);
    }

    selectEl.addEventListener("change", () => {
      const compId = selectEl.value;
      if (compId) {
        loadCompetitionWithDivisionsAndEntries(Number(compId));
      } else {
        renderResults(null, []);
      }
    });

    clearBtn.addEventListener("click", () => {
      selectEl.value = "";
      renderResults(null, []);
    });

    (async function init() {
      await loadCompetitions();
    })();
  </script>
</body>
</html>

