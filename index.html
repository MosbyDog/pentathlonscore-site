<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PentathlonScore – Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #111827;
      color: #f9fafb;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .logo {
      font-weight: 600;
      font-size: 1.1rem;
      text-decoration: none;
      color: #f9fafb;
    }
    nav { display: flex; gap: 12px; margin-top: 6px; }
    .nav-link {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .nav-link:hover { background: #1f2937; }
    .nav-link.active { background: #4f46e5; color: #f9fafb; }

    main { max-width: 1100px; margin: 16px auto 40px; padding: 0 12px; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 14px 14px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    h1 { font-size: 1.4rem; margin: 0 0 4px; }
    h2 { font-size: 1.1rem; margin: 0 0 4px; }
    p { margin: 4px 0; font-size: 0.9rem; color: #4b5563; }
    .note { font-size: 0.85rem; color: #6b7280; }

    label { display:block; font-size: 0.85rem; margin-bottom: 4px; color:#374151; }
    select {
      width: 100%;
      max-width: 360px;
      padding: 6px 8px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #d1d5db;
    }
    .message { font-size: 0.85rem; margin-top: 6px; color:#6b7280; }
    .message.error { color: #b91c1c; }

    .pill {
      display:inline-block;
      padding:2px 6px;
      font-size:0.75rem;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
      margin-right:4px;
    }
    .pill.status-live { background:#dcfce7; color:#166534; }
    .pill.status-finished { background:#fee2e2; color:#991b1b; }

    .division-jump-container {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
      margin-bottom:4px;
    }
    .division-jump-btn{
      border:1px solid #d1d5db;
      background:#f9fafb;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.8rem;
      cursor:pointer;
      color:#111827;
    }
    .division-jump-btn:hover{ background:#e5e7eb; }

    table { width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:6px; }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
      vertical-align:middle;
    }
    th { background:#f9fafb; font-weight:600; }
    th:first-child, td:first-child { text-align:center; }
    th:nth-child(2), td:nth-child(2) { text-align:left; }
    th:not(:first-child):not(:nth-child(2)),
    td:not(:first-child):not(:nth-child(2)) { text-align:right; }
    tr:nth-child(even) td { background:#f9fafb; }

    .rank-cell { font-weight:600; width:60px; }
    .name-cell{
      font-weight:500;
      max-width:190px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .noc-cell { font-size:0.8rem; color:#6b7280; }

    td.disc-cell, th.disc-head { text-align:center !important; }
    .disc-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      line-height:1.1;
      font-variant-numeric:tabular-nums;
    }
    .disc-top{ font-size:0.82rem; color:#111827; }
    .disc-bottom{ margin-top:2px; font-size:0.85rem; font-weight:600; color:#111827; }

    .handicap-cell{ font-variant-numeric: tabular-nums; }

    .print-btn {
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: none;
      background: #4f46e5;
      color: white;
      cursor: pointer;
      display:none;
    }
    .print-btn:hover { background:#4338ca; }

    @media print {
      header { display:none; }
      .note, select, .message, .division-jump-container, .print-btn { display:none !important; }
      body { background:#fff; }
      .card { box-shadow:none; }
    }
  </style>
</head>
<body>
  <header>
    <a href="/" class="logo">PentathlonScore</a>
    <nav>
      <a href="/" class="nav-link active">Home</a>
      <a href="/admin-login.html" class="nav-link">Admin</a>
    </nav>
  </header>

  <main>
    <div class="card">
      <h1>Results</h1>
      <p class="note">Select a competition to view division leaderboards.</p>

      <label for="competition-select">Competition</label>
      <select id="competition-select">
        <option value="">Select a competition</option>
      </select>

      <div id="competition-message" class="message"></div>
      <div id="competition-meta" style="margin-top:8px;"></div>

      <div id="division-jump-container" class="division-jump-container"></div>

      <button type="button" id="print-btn" class="print-btn">Print Results</button>
    </div>

    <div id="leaderboard-container"></div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://cbwifmgrekugoljcaqoh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNid2lmbWdyZWt1Z29samNhcW9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDcxODYsImV4cCI6MjA4MDI4MzE4Nn0.Rp5MCWYQL9SxbnBEJ7e76gbbd95qsStaLE2Hkhpn47g";

    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const competitionSelect = document.getElementById("competition-select");
    const competitionMessage = document.getElementById("competition-message");
    const competitionMeta = document.getElementById("competition-meta");
    const divisionJumpContainer = document.getElementById("division-jump-container");
    const leaderboardContainer = document.getElementById("leaderboard-container");
    const printBtn = document.getElementById("print-btn");

    const SPECIAL_WORST = new Set(["DNS","DNF","DSQ","EL"]);
    let competitionsCache = [];

    function setMsg(text, isError=false){
      competitionMessage.textContent = text || "";
      competitionMessage.className = "message" + (isError ? " error" : "");
    }

    function formatStatusPill(status){
      const s = (status || "").toLowerCase();
      let cls = "pill";
      if (s === "live") cls += " status-live";
      else if (s === "finished") cls += " status-finished";
      return `<span class="${cls}">${s}</span>`;
    }

    function formatDateRange(start, end){
      if (!start && !end) return "";
      if (start && !end) return start;
      if (!start && end) return end;
      if (start === end) return start;
      return `${start} – ${end}`;
    }

    function formatHandicap(seconds){
      if (seconds == null || isNaN(seconds)) return "";
      const total = Math.round(Number(seconds));
      const abs = Math.abs(total);
      const m = Math.floor(abs / 60);
      const s = abs % 60;
      return `${m}:${s < 10 ? "0"+s : s}`;
    }

    function parseTimeToSeconds(str){
      if (!str) return null;
      const s = String(str).trim();
      if (!s) return null;
      const upper = s.toUpperCase();
      if (SPECIAL_WORST.has(upper)) return null;
      if (/^\d+(\.\d+)?$/.test(s)) return parseFloat(s);
      const parts = s.split(":");
      if (parts.length === 2) {
        const mins = parseFloat(parts[0]);
        const secs = parseFloat(parts[1]);
        if (isNaN(mins) || isNaN(secs)) return null;
        return mins * 60 + secs;
      }
      return null;
    }

    function parseFenceVictories(str){
      if (!str) return null;
      const s = String(str).trim();
      if (!s) return null;
      const upper = s.toUpperCase();
      if (SPECIAL_WORST.has(upper)) return null;
      const m = s.match(/(\d+)\s*[Vv]\b/);
      if (m) {
        const v = parseInt(m[1], 10);
        return isNaN(v) ? null : v;
      }
      if (/^\d+$/.test(s)) return parseInt(s, 10);
      return null;
    }

    function computeDisciplinePlaces(rows, discipline){
      const scored = [];
      for (const r of rows) {
        const raw = (r[discipline]?.raw || "").trim();
        if (!raw) continue;
        const upper = raw.toUpperCase();
        const isWorst = SPECIAL_WORST.has(upper);
        let metric = null;
        if (!isWorst) {
          metric = (discipline === "fence") ? parseFenceVictories(raw) : parseTimeToSeconds(raw);
        }
        scored.push({ entryId: r.entryId, isWorst: isWorst || metric == null, metric });
      }
      if (!scored.length) return new Map();

      scored.sort((a,b)=>{
        if (a.isWorst && !b.isWorst) return 1;
        if (!a.isWorst && b.isWorst) return -1;
        if (a.isWorst && b.isWorst) return 0;
        if (discipline === "fence") return b.metric - a.metric; // higher better
        return a.metric - b.metric; // lower better
      });

      const out = new Map();
      let lastKey = null, lastPlace = 0;
      for (let i=0;i<scored.length;i++){
        const s = scored[i];
        const key = s.isWorst ? "WORST" : String(s.metric);
        const place = (i===0) ? 1 : (key===lastKey ? lastPlace : i+1);
        out.set(s.entryId, place);
        lastKey = key; lastPlace = place;
      }
      return out;
    }

    function renderDisciplineCell(raw, pts, place){
      const rawTrim = (raw || "").trim();
      const top = rawTrim ? `${rawTrim}${place ? ` (${place})` : ""}` : "";
      const bottom = (typeof pts === "number") ? String(pts) : "";
      if (!top && !bottom) return "";
      return `
        <div class="disc-wrap">
          <div class="disc-top">${top}</div>
          <div class="disc-bottom">${bottom}</div>
        </div>
      `;
    }

    function renderDivisionJumpButtons(comp){
      const divisions = (comp.divisions || []).slice().sort((a,b)=>{
        const ao = a.order_index ?? 0, bo = b.order_index ?? 0;
        if (ao !== bo) return ao - bo;
        return (a.name||"").localeCompare(b.name||"");
      });
      divisionJumpContainer.innerHTML = divisions.map(d => `
        <button class="division-jump-btn" type="button" onclick="scrollToDivision('division-${d.id}')">
          ${d.name || "Division"}
        </button>
      `).join("");
    }

    function buildDivisionRows(div){
      const entries = div.entries || [];
      const rows = entries.map(e=>{
        const a = e.athletes || {};
        const res = e.results || [];

        const byDisc = { fence:{raw:"",pts:null}, swim:{raw:"",pts:null}, obstacle:{raw:"",pts:null}, laser:{raw:"",pts:null} };
        for (const r of res){
          if (!r?.discipline || !byDisc[r.discipline]) continue;
          byDisc[r.discipline] = { raw: r.raw_value || "", pts: (typeof r.points === "number") ? r.points : (r.points==null?null:Number(r.points)) };
        }

        const total = ["fence","swim","obstacle","laser"].reduce((sum,d)=> sum + (typeof byDisc[d].pts === "number" ? byDisc[d].pts : 0), 0);
        const name = `${a.first_name||""} ${a.last_name||""}`.trim();

        return {
          entryId: e.id,
          name,
          noc: a.noc || "",
          fence: byDisc.fence,
          swim: byDisc.swim,
          obstacle: byDisc.obstacle,
          laser: byDisc.laser,
          total,
          handicap: e.handicap
        };
      });

      // total desc; then name for stability
      rows.sort((a,b)=> (b.total - a.total) || a.name.localeCompare(b.name));
      return rows;
    }

    function renderCompetition(comp){
      if (!comp) {
        competitionMeta.innerHTML = "";
        leaderboardContainer.innerHTML = "";
        divisionJumpContainer.innerHTML = "";
        printBtn.style.display = "none";
        return;
      }

      const status = (comp.status || "").toLowerCase();
      const range = formatDateRange(comp.start_date, comp.end_date);
      const meta = `
        ${formatStatusPill(status)}
        ${comp.location ? `<span class="pill">${comp.location}</span>` : ""}
        ${range ? `<span class="pill">${range}</span>` : ""}
      `;
      competitionMeta.innerHTML = meta;

      renderDivisionJumpButtons(comp);

      const divisions = (comp.divisions || []).slice().sort((a,b)=>{
        const ao = a.order_index ?? 0, bo = b.order_index ?? 0;
        if (ao !== bo) return ao - bo;
        return (a.name||"").localeCompare(b.name||"");
      });

      leaderboardContainer.innerHTML = divisions.map(div=>{
        const rows = buildDivisionRows(div);

        const fencePlaces = computeDisciplinePlaces(rows,"fence");
        const swimPlaces = computeDisciplinePlaces(rows,"swim");
        const obstaclePlaces = computeDisciplinePlaces(rows,"obstacle");
        const laserPlaces = computeDisciplinePlaces(rows,"laser");

        let lastPoints=null, lastPlace=0;
        const body = rows.map((r,idx)=>{
          let place;
          if (idx===0) place=1;
          else if (r.total === lastPoints) place = lastPlace;
          else place = idx+1;
          lastPoints = r.total; lastPlace = place;

          return `
            <tr>
              <td class="rank-cell">${place}</td>
              <td>
                <div class="name-cell">${r.name}</div>
                <div class="noc-cell">${r.noc}</div>
              </td>
              <td class="disc-cell">${renderDisciplineCell(r.fence.raw, r.fence.pts, fencePlaces.get(r.entryId) || null)}</td>
              <td class="disc-cell">${renderDisciplineCell(r.swim.raw, r.swim.pts, swimPlaces.get(r.entryId) || null)}</td>
              <td class="disc-cell">${renderDisciplineCell(r.obstacle.raw, r.obstacle.pts, obstaclePlaces.get(r.entryId) || null)}</td>
              <td class="disc-cell">${renderDisciplineCell(r.laser.raw, r.laser.pts, laserPlaces.get(r.entryId) || null)}</td>
              <td style="text-align:right;">${r.total}</td>
              <td class="handicap-cell" style="text-align:right;">${formatHandicap(r.handicap)}</td>
            </tr>
          `;
        }).join("");

        return `
          <div class="card" id="division-${div.id}">
            <div style="display:flex; justify-content:space-between; align-items:baseline; gap:8px; margin-bottom:4px;">
              <h2>${div.name || "Division"}</h2>
              <div style="font-size:0.8rem; color:#6b7280;">
                ${(div.age_group ? `<span class="pill">${div.age_group}</span>` : "")}
                ${(div.gender ? `<span class="pill">${div.gender}</span>` : "")}
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Place</th>
                  <th>Athlete</th>
                  <th class="disc-head">Fence</th>
                  <th class="disc-head">Swim</th>
                  <th class="disc-head">Obstacle</th>
                  <th class="disc-head">Laser Run</th>
                  <th>Total</th>
                  <th>Handicap</th>
                </tr>
              </thead>
              <tbody>${body}</tbody>
            </table>
          </div>
        `;
      }).join("");

      printBtn.style.display = "inline-block";
    }

    async function loadCompetitions(){
      setMsg("Loading competitions...");
      const { data, error } = await sb
        .from("competitions")
        .select(`
          id, name, location, start_date, end_date, status,
          divisions (
            id, name, age_group, gender, order_index,
            entries (
              id, handicap,
              athletes ( first_name, last_name, noc ),
              results ( discipline, raw_value, points )
            )
          )
        `)
        .in("status", ["live","finished"])
        .order("start_date", { ascending:false });

      if (error) {
        setMsg("Failed to load competitions.", true);
        competitionSelect.innerHTML = `<option value="">Select a competition</option>`;
        renderCompetition(null);
        return;
      }

      competitionsCache = data || [];

      competitionSelect.innerHTML = `
        <option value="">Select a competition</option>
        ${competitionsCache.map(c => `<option value="${c.id}">${c.name}</option>`).join("")}
      `;

      renderCompetition(null);
      printBtn.style.display = "none";
    }

    competitionSelect.addEventListener("change", ()=>{
      const id = competitionSelect.value;
      if (!id) { renderCompetition(null); return; }
      const comp = competitionsCache.find(c => String(c.id) === String(id));
      if (!comp) return;
      setMsg("");
      renderCompetition(comp);
    });

    printBtn.addEventListener("click", ()=> window.print());

    function scrollToDivision(id){
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior:"smooth", block:"start" });
    }
    window.scrollToDivision = scrollToDivision;

    loadCompetitions();
  </script>
</body>
</html>

